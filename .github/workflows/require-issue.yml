name: Require Linked Issue

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check for closing keywords
            const closingKeywords = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i;

            // Check for "Part of #" references
            const partOfKeywords = /part\s+of\s+#\d+/i;

            // Check for linked issues via GitHub API
            const { data: timeline } = await github.rest.issues.listEventsForTimeline({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const hasLinkedIssue = timeline.some(event =>
              event.event === 'cross-referenced' ||
              event.event === 'connected'
            );

            const hasClosingKeyword = closingKeywords.test(body);
            const hasPartOfKeyword = partOfKeywords.test(body);

            if (!hasLinkedIssue && !hasClosingKeyword && !hasPartOfKeyword) {
              core.setFailed(
                'PR must be linked to an issue. Use "Closes #N", "Fixes #N", or "Part of #N" in the PR description.'
              );
            } else {
              console.log('âœ… PR is linked to an issue');
            }
